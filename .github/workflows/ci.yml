name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv pip install .[dev]

    - name: Run Unit Tests
      run: uv run pytest tests/

    - name: Run Integration Test (Dry Run without LLM)
      # We run the agent but expect it might fail or return fallback values since no LLM is present in CI.
      # This ensures the code runs without crashing.
      run: |
        uv run python run_agent_hybrid.py --batch sample_questions_hybrid_eval.jsonl --out outputs.jsonl || true
        if [ -f outputs.jsonl ]; then
          echo "Integration test produced output."
        else
          echo "Integration test failed to produce output."
          exit 1
        fi
